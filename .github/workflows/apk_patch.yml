name: APK Patch and Build
on:
  workflow_dispatch:

jobs:
  patch-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Dependencies
        run: |
          mkdir -p bin
          curl -L https://github.com/WindySha/ManifestEditor/releases/download/v2.0/ManifestEditor-2.0.jar -o bin/ManifestEditor.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Download APK
        run: curl -L https://github.com/uazo/cromite/releases/latest/download/arm64_ChromePublic.apk -o original.apk

      - name: Extract Package Name
        run: |
          PKG_NAME=$($ANDROID_HOME/build-tools/34.0.0/aapt dump badging original.apk | grep -oP "package: name='\K[^']+")
          echo "PKG_NAME=$PKG_NAME" >> $GITHUB_ENV

      - name: Modify Manifest with ManifestEditor
        run: |
          # 1. 注入 Provider 标签
          java -jar bin/ManifestEditor.jar original.apk -out step1.apk \
          --add-tag provider \
          --attr name=lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs \
          --attr permission=android.permission.MANAGE_DOCUMENTS \
          --attr exported=true \
          --attr authorities=${{ env.PKG_NAME }}.LMTjkeQefuwPwtntzcs \
          --attr grantUriPermissions=true \
          --parent application

          # 2. 在 Provider 内部注入 intent-filter
          java -jar bin/ManifestEditor.jar step1.apk -out step2.apk \
          --add-tag intent-filter \
          --parent provider \
          --where name=lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs

          # 3. 在 intent-filter 内部注入 action
          java -jar bin/ManifestEditor.jar step2.apk -out modified_manifest.apk \
          --add-tag action \
          --attr name=android.content.action.DOCUMENTS_PROVIDER \
          --parent intent-filter \
          --where-parent provider \
          --where name=lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs

      - name: Verify Manifest
        run: |
          $ANDROID_HOME/build-tools/34.0.0/aapt dump badging modified_manifest.apk | grep sdkVersion

      - name: Inject Files into APK
        run: |
          # 处理 Proxy Lib
          curl -L https://github.com/lhear/httproxy/releases/latest/download/httproxy-android-arm64.zip -o proxy.zip
          unzip -j proxy.zip "client" -d tmp_lib
          mv tmp_lib/client tmp_lib/libproxy.so
          
          # 计算并重命名 DEX (patch.dex 需存在于仓库根目录)
          DEX_COUNT=$(zipinfo -1 modified_manifest.apk | grep "classes.*\.dex" | wc -l)
          NEXT_IDX=$((DEX_COUNT + 1))
          cp patch.dex "classes${NEXT_IDX}.dex"

          # 压入库文件和 DEX
          mkdir -p lib/arm64-v8a
          cp tmp_lib/libproxy.so lib/arm64-v8a/
          zip -ur modified_manifest.apk lib/arm64-v8a/libproxy.so "classes${NEXT_IDX}.dex"

      - name: Zipalign
        run: |
          ZIPALIGN_PATH=$(find $ANDROID_HOME/build-tools -name "zipalign" | sort -V | tail -n 1)
          $ZIPALIGN_PATH -f -v 4 modified_manifest.apk aligned.apk

      - name: Sign APK
        run: |
          APKSIGNER_PATH=$(find $ANDROID_HOME/build-tools -name "apksigner" | sort -V | tail -n 1)
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          $APKSIGNER_PATH sign --ks release.keystore \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --v1-signing-enabled false \
            --v2-signing-enabled false \
            --v3-signing-enabled true \
            --v4-signing-enabled false \
            --out cromite-arm64.apk aligned.apk

      - name: Upload Patched APK
        uses: actions/upload-artifact@v4
        with:
          name: cromite-arm64
          path: cromite-arm64.apk
