name: APK Patch and Build

on:
  workflow_dispatch:

jobs:
  patch-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y patch
          mkdir -p bin
          curl -L https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -o bin/apktool
          curl -L https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.12.1.jar -o bin/apktool.jar
          chmod +x bin/apktool bin/apktool.jar
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      - name: Download APK
        run: curl -L https://github.com/uazo/cromite/releases/latest/download/arm64_ChromePublic.apk -o original.apk

      - name: Decompile APK
        run: apktool d -s original.apk -o decompiled_source

      - name: Get Manifest Info
        run: |
          echo "PKG_NAME=$(grep -oP 'package="\K[^"]+' decompiled_source/AndroidManifest.xml)" >> $GITHUB_ENV
          echo "NS_PREFIX=$(grep -oP '\K[a-zA-Z0-9]+(?=:name)' decompiled_source/AndroidManifest.xml | head -n 1)" >> $GITHUB_ENV

      - name: Inject Provider to Manifest
        run: |
          PROVIDER_BLOCK="<provider ${{ env.NS_PREFIX }}:name=\"lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs\" ${{ env.NS_PREFIX }}:permission=\"android.permission.MANAGE_DOCUMENTS\" ${{ env.NS_PREFIX }}:exported=\"true\" ${{ env.NS_PREFIX }}:authorities=\"${{ env.PKG_NAME }}.LMTjkeQefuwPwtntzcs\" ${{ env.NS_PREFIX }}:grantUriPermissions=\"true\"><intent-filter><action ${{ env.NS_PREFIX }}:name=\"android.content.action.DOCUMENTS_PROVIDER\" /></intent-filter></provider>"
          sed -i "/<\/application>/i $PROVIDER_BLOCK" decompiled_source/AndroidManifest.xml

      - name: Setup Proxy Lib
        run: |
          curl -L https://github.com/lhear/httproxy/releases/latest/download/httproxy-android-arm64.zip -o proxy.zip
          unzip -o proxy.zip -d proxy
          mkdir -p decompiled_source/lib/arm64-v8a/
          cp proxy/client decompiled_source/lib/arm64-v8a/libproxy.so

      - name: Increment and Copy DEX
        run: |
          DEX_COUNT=$(find decompiled_source -maxdepth 1 -name "classes*.dex" | wc -l)
          NEXT_IDX=$((DEX_COUNT + 1))
          cp patch.dex "decompiled_source/classes${NEXT_IDX}.dex"

      - name: Rebuild APK
        run: apktool b decompiled_source -o unsigned.apk

      - name: Zipalign
        run: |
          ZIPALIGN_PATH=$(find $ANDROID_HOME/build-tools -name "zipalign" | sort -V | tail -n 1)
          $ZIPALIGN_PATH -f -v 4 unsigned.apk aligned.apk

      - name: Sign APK
        run: |
          APKSIGNER_PATH=$(find $ANDROID_HOME/build-tools -name "apksigner" | sort -V | tail -n 1)
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          $APKSIGNER_PATH sign --ks release.keystore \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --v1-signing-enabled false \
            --v2-signing-enabled false \
            --v3-signing-enabled true \
            --v4-signing-enabled false \
            --out cromite-arm64.apk aligned.apk
          $APKSIGNER_PATH verify -v cromite-arm64.apk

      - name: Upload Patched APK
        uses: actions/upload-artifact@v4
        with:
          name: cromite-arm64
          path: cromite-arm64.apk

      - name: Upload Manifest on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: manifest
          path: decompiled_source/AndroidManifest.xml
