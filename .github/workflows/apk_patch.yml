name: APK Patch and Build

on:
  workflow_dispatch:

jobs:
  patch-apk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Download Tools and APK
        run: |
          mkdir -p bin
          curl -L https://github.com/WindySha/ManifestEditor/releases/download/v2.0/ManifestEditor-2.0.jar -o bin/manifest-editor.jar
          curl -L https://github.com/uazo/cromite/releases/latest/download/arm64_ChromePublic.apk -o original.apk
          curl -L https://github.com/lhear/httproxy/releases/latest/download/httproxy-android-arm64.zip -o proxy.zip
          unzip -j proxy.zip client -d . && mv client libproxy.so

      - name: Modify AndroidManifest.xml
        run: |
          unzip original.apk AndroidManifest.xml -d .
          AAPT2_PATH=$(find $ANDROID_HOME/build-tools -name "aapt2" | sort -V | tail -n 1)
          PKG_NAME=$($AAPT2_PATH dump packagename original.apk)
          echo "Detected Package: $PKG_NAME"
          java -jar bin/manifest-editor.jar \
            --input AndroidManifest.xml \
            --output AndroidManifest_mod1.xml \
            --add-tag "provider" \
            --where "application" \
            --attribute "name" "lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs" \
            --attribute "authorities" "$PKG_NAME.LMTjkeQefuwPwtntzcs" \
            --attribute "exported" "true" \
            --attribute "permission" "android.permission.MANAGE_DOCUMENTS" \
            --attribute "grantUriPermissions" "true"
          java -jar bin/manifest-editor.jar \
            --input AndroidManifest_mod1.xml \
            --output AndroidManifest_mod2.xml \
            --add-tag "intent-filter" \
            --where "provider[name='lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs']"
          java -jar bin/manifest-editor.jar \
            --input AndroidManifest_mod2.xml \
            --output AndroidManifest_final.xml \
            --add-tag "action" \
            --where "provider[name='lck.qb.qipf.vkeszwc.LMTjkeQefuwPwtntzcs']/intent-filter" \
            --attribute "name" "android.content.action.DOCUMENTS_PROVIDER"

      - name: Build Patched APK
        run: |
          cp original.apk patched.apk
          zip -j patched.apk AndroidManifest_final.xml
          printf "AndroidManifest.xml" > .zip_rename_manifest
          zip -m patched.apk AndroidManifest_final.xml && printf "AndroidManifest_final.xml\nAndroidManifest.xml" | xargs -n2 -d'\n' zipnote -w patched.apk || true
          mv AndroidManifest_final.xml AndroidManifest.xml
          zip -g patched.apk AndroidManifest.xml
          zip -g patched.apk lib/arm64-v8a/libproxy.so
          DEX_COUNT=$(unzip -l original.apk | grep "classes.*.dex" | wc -l)
          NEXT_IDX=$((DEX_COUNT + 1))
          if [ -f "patch.dex" ]; then
            cp patch.dex "classes${NEXT_IDX}.dex"
            zip -g patched.apk "classes${NEXT_IDX}.dex"
          else
            echo "Warning: patch.dex not found, skipping dex injection."
          fi

      - name: Zipalign and Sign
        run: |
          ZIPALIGN=$(find $ANDROID_HOME/build-tools -name "zipalign" | sort -V | tail -n 1)
          APKSIGNER=$(find $ANDROID_HOME/build-tools -name "apksigner" | sort -V | tail -n 1)
          $ZIPALIGN -f -v 4 patched.apk aligned.apk
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          $APKSIGNER sign --ks release.keystore \
            --ks-key-alias "${{ secrets.KEY_ALIAS }}" \
            --ks-pass pass:"${{ secrets.KEYSTORE_PASSWORD }}" \
            --key-pass pass:"${{ secrets.KEY_PASSWORD }}" \
            --v3-signing-enabled true \
            --out cromite-patched-arm64.apk aligned.apk

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: patched-chrome
          path: cromite-patched-arm64.apk
